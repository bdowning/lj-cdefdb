#!/bin/sh

# Copyright (C) 2014-2015 Brian Downing.  MIT License.

set -e

if [ -z "$1" ]; then
    echo Usage: $0 '(file.c|-)' '<cc args...>' >&2
    exit 1
fi

file="$1"; shift
. "$(dirname "$0")"/functions.sh

pp_tmpdir="/tmp/lj-cdefdb-$$"
mkdir -p "$pp_tmpdir"
trap "rm -rf $pp_tmpdir" 0
pp_output="$pp_tmpdir/preprocessed$$.c"
${CLANG:-clang} -E -dD "$@" "$file" > "$pp_output"

hash=$(sha1sum "$pp_output" | cut -b1-8)

mkdir "$pp_tmpdir"/out
run_in_ljclang ../process.lua "$pp_output" "$pp_tmpdir"/out "$hash"
cp "$pp_tmpdir"/out/* .

#${CC:-cc} -fPIC -shared -O2 -o cdefdb.so cdefdb.c
#echo "cdefdb.so generated" >&2
